obj = {
    "observations": [{
        "ipv6": None,
        "ipv4": None,
        "ssid": None,
        "location": {
            "unc": 12.949704944981216,
            "y": [],
            "lng": 30.478811086822134,
            "x": [],
            "lat": 50.37944278510648

        },
        "seenTime": "2017-03-16T13:52:00Z",
        "rssi": 26,
        "os": None,
        "manufacturer": "Intel",
        "clientMac": "78:0c:b8:a2:c7:81",
        "seenEpoch": 1489672320

    },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location": {
                "unc": 7.994796543091113,
                "y": [],
                "lng": 30.47902674886737,
                "x": [],
                "lat": 50.37946338081357},
            "seenTime": "2017-03-16T13:51:57Z",
            "rssi": 33,
            "os": "Mac OS X",
            "manufacturer": "Apple",
            "clientMac": "78:31:c1:ba:24:46",
            "seenEpoch": 1489672317

        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location": {
                "unc": 20.152192058468202,
                "y": [],
                "lng": 30.479129714927865,
                "x": [],
                "lat": 50.379455777035865
            },
            "seenTime": "2017-03-16T13:51:57Z",
            "rssi": 18,
            "os": "Windows",
            "manufacturer": "Intel",
            "clientMac": "00:22:fa:ad:c1:1c",
            "seenEpoch": 1489672317

        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location": {
                "unc": 14.244675417030098,
                "y": [],
                "lng": 30.47885113826794,
                "x": [],
                "lat": 50.379582314684995
            },
            "seenTime": "2017-03-16T13:52:05Z",
            "rssi": 29,
            "os": None,
            "manufacturer": "Shanghai Huaqin Telecom...",
            "clientMac": "90:21:81:da:ed:12",
            "seenEpoch": 1489672325
        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location": {
                "unc": 37.872191057754456,
                "y": [],
                "lng": 30.478976363468973,
                "x": [],
                "lat": 50.379512339465414

            },
            "seenTime": "2017-03-16T13:52:00Z",
            "rssi": 19,
            "os": None,
            "manufacturer": "Lenovo (Beijing)",
            "clientMac": "a0:32:99:56:7a:a8",
            "seenEpoch": 1489672320

        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location": {
                "unc": 33.52264639140593,
                "y": [],
                "lng": 30.478996257425024,
                "x": [],
                "lat": 50.37954085597527},
            "seenTime": "2017-03-16T13:52:06Z",
            "rssi": 19, "os": None, "manufacturer": "Sony Mobile...", "clientMac": "44:74:6c:af:89:a6",
            "seenEpoch": 1489672326
        },
        {
            "ipv6": None,
            "ipv4": "/192.168.129.31",
            "ssid": "Presentation",
            "location":
                {
                    "unc": 2.3013535751319965,
                    "y": [],
                    "lng": 30.479023829100072,
                    "x": [],
                    "lat": 50.37952456901708
                },
            "seenTime": "2017-03-16T13:52:04Z",
            "rssi": 52,
            "os": "Mac OS X",
            "manufacturer": "Apple",
            "clientMac": "5c:f9:38:a6:92:5c",
            "seenEpoch": 1489672324
        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location":
                {
                    "unc": 16.18135812700672,
                    "y": [],
                    "lng": 30.47870972226798,
                    "x": [],
                    "lat": 50.379559493359444
                },
            "seenTime": "2017-03-16T13:52:00Z",
            "rssi": 22,
            "os": None,
            "manufacturer": "Shenzhen Xin KingBrand...",
            "clientMac": "28:fc:f6:04:03:25",
            "seenEpoch": 1489672320
        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location":
                {
                    "unc": 4.405474095840357,
                    "y": [],
                    "lng": 30.478972593873436,
                    "x": [],
                    "lat": 50.37950511623386
                },
            "seenTime": "2017-03-16T13:51:59Z",
            "rssi": 32,
            "os": "Android",
            "manufacturer": "Sony Mobile...",
            "clientMac": "40:40:a7:32:f8:66",
            "seenEpoch": 1489672319
        },
        {
            "ipv6": None, "ipv4": None, "ssid": None,
            "location":
                {
                    "unc": 9.284169514699853,
                    "y": [],
                    "lng": 30.47903686376003,
                    "x": [],
                    "lat": 50.379473109389956},
            "seenTime": "2017-03-16T13:51:57Z",
            "rssi": 26, "os": "Mac OS X",
            "manufacturer": "Apple",
            "clientMac": "a0:99:9b:06:84:43",
            "seenEpoch": 1489672317
        },
        {
            "ipv6": None,
            "ipv4": None,
            "ssid": None,
            "location":
                {
                    "unc": 37.30749439490675,
                    "y": [],
                    "lng": 30.478977405946353,
                    "x": [],
                    "lat": 50.3795127134878},
            "seenTime": "2017-03-16T13:52:04Z",
            "rssi": 19,
            "os": "iOS",
            "manufacturer": "Apple",
            "clientMac": "54:72:4f:9b:18:82",
            "seenEpoch": 1489672324
        }
    ],
    "apMac": "88:15:44:2c:7b:30",
    "apTags":
        ["234234234", "sdfghskdjhgksjhdhg"],
    "apFloors": ["1st-Floor", "2nd-Floor", "3rd_floor"]

}

import datetime
import time

import database

session = database.Session()
engine = database.engine

def write_routers_to_db():
    tr = """INSERT INTO meraki_db.role (rolename) VALUES ('admin');
            INSERT INTO meraki_db.role (rolename) VALUES ('user');"""
    engine.connect().execute(tr)
    with open("apMac.txt", "r") as f:
        e = database.Event("test", "test", datetime.datetime.now(), datetime.datetime.now())
        for apMac in f.readlines():
            s = database.ApMac(apMac.strip(), "RouterName")
            e.routers.append(s)
            session.add(e)
        session.commit()


def db(obj):
    apMac_row = obj.pop('apMac')
    apMac_table = session.query(database.apMac).filter_by(apMac=apMac_row).one_or_none()

    def add_session(*args, **kwargs):
        database_table_method = getattr(database, class_name)
        o = database_table_method(*args, **kwargs)
        getattr(apMac_table, class_name).append(o)
        session.add(o)

    if apMac_table:
        for class_name, class_value in obj.items():
            if isinstance(class_value, list) and class_name in dir(database):
                for i in class_value:
                    if isinstance(i, (str, int, float)):
                        try:
                            print(class_name)
                            q = getattr(apMac_table, class_name)
                            if i not in (getattr(row, class_name) for row in q):
                                add_session(i)
                        except Exception:
                            add_session(i)

                    elif isinstance(i, dict):
                        if not check_black_list(i['clientMac']):
                            del i["location"]
                            i['seenTime'] = datetime.datetime.strptime(i["seenTime"], "%Y-%m-%dT%H:%M:%SZ")
                            i['seenEpoch'] = (i['seenTime'] - datetime.datetime.strptime(time.ctime(i['seenEpoch']),
                                                                                        "%a %b %d %H:%M:%S %Y")).seconds//3600

                            print(i['seenEpoch'])

                            add_session(**i)
            session.commit()
    else:
        pass


def check_black_list(str):
    bl = (i.clientMac for i in session.query(database.BlackBook).all())
    if str in bl:
        session.query(database.observations).filter_by(clientMac=str).delete()
        return True
    else:
        return False


write_routers_to_db()
